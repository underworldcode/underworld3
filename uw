#!/bin/bash
#
# Underworld3 environment wrapper
#
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIG_FILE="$SCRIPT_DIR/.pixi-env"
PETSC_CUSTOM="$SCRIPT_DIR/petsc-custom/petsc"

# Colors (if terminal supports it)
if [ -t 1 ]; then
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BOLD='\033[1m'
    NC='\033[0m'
else
    GREEN='' YELLOW='' BOLD='' NC=''
fi

get_env() {
    if [ -f "$CONFIG_FILE" ]; then
        cat "$CONFIG_FILE" | tr -d '[:space:]'
    else
        echo "runtime"
    fi
}

petsc_built() {
    [ -d "$PETSC_CUSTOM/petsc-4-uw/lib" ]
}

# Check and install pixi if needed
check_pixi() {
    if command -v pixi &> /dev/null; then
        return 0
    fi

    echo -e "${YELLOW}Pixi package manager not found.${NC}"
    echo ""
    echo "Pixi is required to manage Underworld3 dependencies."
    echo "Install from: https://pixi.sh"
    echo ""
    read -p "Install pixi now? [Y/n]: " install_pixi
    install_pixi=${install_pixi:-y}

    if [ "$install_pixi" = "y" ] || [ "$install_pixi" = "Y" ]; then
        echo ""
        echo "Installing pixi..."
        curl -fsSL https://pixi.sh/install.sh | bash

        # Source shell config to get pixi in PATH
        if [ -f "$HOME/.bashrc" ]; then
            source "$HOME/.bashrc" 2>/dev/null || true
        fi
        if [ -f "$HOME/.zshrc" ]; then
            source "$HOME/.zshrc" 2>/dev/null || true
        fi

        # Check if install succeeded
        if command -v pixi &> /dev/null; then
            echo -e "${GREEN}✓ Pixi installed successfully${NC}"
            echo ""
            return 0
        else
            echo ""
            echo -e "${YELLOW}Pixi installed but not in PATH.${NC}"
            echo "Please restart your terminal and run './uw setup' again."
            exit 0
        fi
    else
        echo ""
        echo "Install pixi manually from https://pixi.sh then run './uw setup'"
        exit 1
    fi
}

# Interactive setup wizard
run_setup() {
    # Ensure pixi is available
    check_pixi

    echo -e "${BOLD}Underworld3 Setup${NC}"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""

    # Question 1: AMR tools?
    echo -e "${BOLD}Do you need adaptive mesh refinement (AMR) tools?${NC}"
    echo "  (pragmatic, mmg, parmmg for anisotropic mesh adaptation)"
    echo ""
    echo "  [1] No  - conda-forge PETSc (5-minute install)"
    echo "  [2] Yes - custom PETSc build (~1 hour)"
    echo ""
    read -p "Choice [1]: " amr_choice
    amr_choice=${amr_choice:-1}

    local use_amr=false
    [ "$amr_choice" = "2" ] && use_amr=true

    echo ""

    # Question 2: Features?
    echo -e "${BOLD}What features do you need?${NC}"
    echo ""
    echo "  [1] Minimal   - build and run only"
    echo "  [2] Runtime   - add visualization + Jupyter"
    echo "  [3] Developer - add Claude, linting, docs"
    echo ""
    read -p "Choice [2]: " feature_choice
    feature_choice=${feature_choice:-2}

    # Determine environment
    local new_env
    if [ "$use_amr" = true ]; then
        case "$feature_choice" in
            1) new_env="amr" ;;
            3) new_env="amr-dev" ;;
            *) new_env="amr-runtime" ;;
        esac
    else
        case "$feature_choice" in
            1) new_env="default" ;;
            3) new_env="dev" ;;
            *) new_env="runtime" ;;
        esac
    fi

    echo ""
    echo -e "Environment: ${GREEN}$new_env${NC}"
    echo "$new_env" > "$CONFIG_FILE"
    echo ""

    # Install
    echo "Installing dependencies..."
    pixi install -e "$new_env"
    echo ""

    # AMR-specific
    if [ "$use_amr" = true ]; then
        if petsc_built; then
            echo -e "${GREEN}✓ Custom PETSc already built${NC}"
            echo "Installing petsc4py..."
            (cd "$PETSC_CUSTOM/src/binding/petsc4py" && pixi run -e "$new_env" python setup.py install) 2>/dev/null
        else
            echo -e "${YELLOW}Custom PETSc needs to be built (~1 hour)${NC}"
            read -p "Build now? [y/N]: " build_now
            if [ "$build_now" = "y" ] || [ "$build_now" = "Y" ]; then
                pixi run -e "$new_env" ./petsc-custom/build-petsc.sh
            else
                echo ""
                echo "Build later with: ./uw petsc-local-build"
                echo ""
            fi
        fi
    fi

    # Build underworld3
    echo ""
    read -p "Build underworld3? [Y/n]: " build_uw
    build_uw=${build_uw:-y}
    if [ "$build_uw" = "y" ] || [ "$build_uw" = "Y" ]; then
        pixi run -e "$new_env" pip install . --no-build-isolation
    fi

    echo ""
    echo -e "${GREEN}${BOLD}Setup complete!${NC}"
    echo ""
    echo "Usage:"
    echo "  ./uw build          Build underworld3"
    echo "  ./uw test           Run tests"

    # Show Jupyter info
    case "$new_env" in
        default|amr)
            echo ""
            echo "Note: Minimal environment - no JupyterLab/visualization."
            echo "Notebooks work via IDE kernels (VS Code, etc)."
            echo "Run './uw setup' again to add JupyterLab."
            ;;
        *)
            echo "  ./uw jupyter lab    Start JupyterLab"
            ;;
    esac
    echo ""
    echo "For VS Code / IDE Jupyter kernels, set pixi environment to: $new_env"
}

# Show comprehensive help
show_help() {
    cat << 'EOF'
UNDERWORLD3 ENVIRONMENT WRAPPER
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

QUICK START

  ./uw setup              Configure environment (interactive)
  ./uw build              Build underworld3
  ./uw test               Run tests (level 1, ~2 min)
  ./uw jupyter lab        Start JupyterLab

ENVIRONMENTS

  ┌─────────────┬──────────────────┬─────────────────────────────────┐
  │ Environment │ PETSc            │ Features                        │
  ├─────────────┼──────────────────┼─────────────────────────────────┤
  │ default     │ conda-forge      │ minimal                         │
  │ runtime     │ conda-forge      │ + pyvista, jupyter              │
  │ dev         │ conda-forge      │ + claude, black, mypy           │
  ├─────────────┼──────────────────┼─────────────────────────────────┤
  │ amr         │ custom (~1hr)    │ minimal + AMR tools             │
  │ amr-runtime │ custom (~1hr)    │ + pyvista, jupyter              │
  │ amr-dev     │ custom (~1hr)    │ + claude, black, mypy           │
  └─────────────┴──────────────────┴─────────────────────────────────┘

COMMANDS

  Setup:
    setup               Interactive configuration wizard
    set-env NAME        Change environment directly

  Building:
    build               Build underworld3
    clean               Clean build artifacts
    petsc-local-build   Build custom PETSc + petsc4py (AMR, ~1 hour)
    petsc-local-clean   Remove custom PETSc build

  Testing:
    test [opts]         Level 1 tests (~2 min, fast mode)
    test-all [opts]     All test levels (~20 min)

    Options pass through to test script:
      --isolation       Run each file in subprocess (thorough)
      --parallel        Include MPI tests (2 ranks)
      --parallel-ranks N  MPI tests with N ranks
      1,2,3             Override test levels

    Examples:
      ./uw test                     Quick level 1, fast mode
      ./uw test --isolation         Level 1 with process isolation
      ./uw test --parallel 2        Level 2 with MPI tests
      ./uw test-all --isolation     All levels, isolated (CI mode)
      ./uw test --help              Show all test options

  Development:
    shell               Interactive pixi shell
    jupyter [args]      Run jupyter
    format              Run black
    type-check          Run mypy

  Any command not listed is passed to: pixi run -e $ENV <command>

FILES

  .pixi-env             Your environment choice (git-ignored)
  pixi.toml             Environment definitions (versioned)
  petsc-custom/petsc/   Custom PETSc build (git-ignored)

EOF
}

# Brief welcome + offer setup
show_welcome() {
    echo -e "${BOLD}Underworld3${NC}"
    echo ""

    # Check for pixi first
    if ! command -v pixi &> /dev/null; then
        echo "Environment: (pixi not installed)"
        echo ""
        read -p "Run setup to install pixi? [Y/n]: " do_setup
        do_setup=${do_setup:-y}
        if [ "$do_setup" = "y" ] || [ "$do_setup" = "Y" ]; then
            echo ""
            run_setup
        else
            echo ""
            echo "Install pixi from https://pixi.sh then run './uw setup'"
        fi
        return
    fi

    if [ -f "$CONFIG_FILE" ]; then
        local current_env=$(get_env)
        echo -e "Environment: ${GREEN}$current_env${NC}"
        echo ""
        echo "Commands:  ./uw setup    ./uw build    ./uw test    ./uw --help"
    else
        echo "Environment: (not configured)"
        echo ""
        read -p "Run setup? [Y/n]: " do_setup
        do_setup=${do_setup:-y}
        if [ "$do_setup" = "y" ] || [ "$do_setup" = "Y" ]; then
            echo ""
            run_setup
        else
            echo ""
            echo "Run './uw setup' when ready, or './uw --help' for options."
        fi
    fi
}

# Main
case "${1:-}" in
    "")
        show_welcome
        ;;
    setup)
        run_setup
        ;;
    set-env)
        if [ -z "$2" ]; then
            echo "Usage: ./uw set-env <environment>"
            echo "Options: default, runtime, dev, amr, amr-runtime, amr-dev"
            exit 1
        fi
        echo "$2" > "$CONFIG_FILE"
        echo "Environment: $2"
        echo "Run './uw build' to rebuild underworld3"
        ;;
    shell)
        shift
        exec pixi shell -e "$(get_env)" "$@"
        ;;
    jupyter)
        shift
        exec pixi run -e "$(get_env)" jupyter "$@"
        ;;
    --help|-h|help)
        show_help
        ;;
    *)
        exec pixi run -e "$(get_env)" "$@"
        ;;
esac
