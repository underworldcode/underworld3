============================= test session starts ==============================
platform darwin -- Python 3.12.11, pytest-8.4.1, pluggy-1.6.0 -- /Users/lmoresi/+Underworld/underworld-pixi-2/.pixi/envs/default/bin/python3.12
cachedir: .pytest_cache
rootdir: /Users/lmoresi/+Underworld/underworld-pixi-2/underworld3/tests
configfile: pytest.ini
plugins: mpi-0.6, anyio-4.9.0, timeout-2.4.0, typeguard-4.4.4
collecting ... collected 30 items

tests/test_0850_units_closure_comprehensive.py::test_closure_variable_multiply_variable FAILED [  3%]
tests/test_0850_units_closure_comprehensive.py::test_units_temperature_times_velocity PASSED [  6%]
tests/test_0850_units_closure_comprehensive.py::test_closure_temperature_times_velocity_component PASSED [ 10%]
tests/test_0850_units_closure_comprehensive.py::test_closure_scalar_times_variable FAILED [ 13%]
tests/test_0850_units_closure_comprehensive.py::test_closure_scalar_times_temperature_times_velocity_component PASSED [ 16%]
tests/test_0850_units_closure_comprehensive.py::test_units_scalar_preserves_variable_units PASSED [ 20%]
tests/test_0850_units_closure_comprehensive.py::test_closure_derivative_is_unit_aware PASSED [ 23%]
tests/test_0850_units_closure_comprehensive.py::test_units_temperature_derivative PASSED [ 26%]
tests/test_0850_units_closure_comprehensive.py::test_closure_second_derivative FAILED [ 30%]
tests/test_0850_units_closure_comprehensive.py::test_closure_temperature_divided_by_coordinate PASSED [ 33%]
tests/test_0850_units_closure_comprehensive.py::test_units_temperature_divided_by_length PASSED [ 36%]
tests/test_0850_units_closure_comprehensive.py::test_closure_variable_divided_by_variable PASSED [ 40%]
tests/test_0850_units_closure_comprehensive.py::test_closure_vector_component_access PASSED [ 43%]
tests/test_0850_units_closure_comprehensive.py::test_closure_vector_component_in_expression PASSED [ 46%]
tests/test_0850_units_closure_comprehensive.py::test_units_vector_component_preserves_units PASSED [ 50%]
tests/test_0850_units_closure_comprehensive.py::test_closure_mesh_coordinates_are_unit_aware PASSED [ 53%]
tests/test_0850_units_closure_comprehensive.py::test_closure_coordinate_in_expression PASSED [ 56%]
tests/test_0850_units_closure_comprehensive.py::test_units_coordinate_access PASSED [ 60%]
tests/test_0850_units_closure_comprehensive.py::test_units_addition_requires_compatible_units PASSED [ 63%]
tests/test_0850_units_closure_comprehensive.py::test_units_addition_incompatible_units_fails FAILED [ 66%]
tests/test_0850_units_closure_comprehensive.py::test_closure_variable_squared PASSED [ 70%]
tests/test_0850_units_closure_comprehensive.py::test_units_temperature_squared PASSED [ 73%]
tests/test_0850_units_closure_comprehensive.py::test_closure_complex_expression PASSED [ 76%]
tests/test_0850_units_closure_comprehensive.py::test_closure_derivative_of_product PASSED [ 80%]
tests/test_0850_units_closure_comprehensive.py::test_units_energy_like_expression PASSED [ 83%]
tests/test_0850_units_closure_comprehensive.py::test_closure_unit_aware_array_arithmetic PASSED [ 86%]
tests/test_0850_units_closure_comprehensive.py::test_closure_unit_aware_array_reductions PASSED [ 90%]
tests/test_0850_units_closure_comprehensive.py::test_closure_coordinate_operations PASSED [ 93%]
tests/test_0850_units_closure_comprehensive.py::test_closure_evaluate_returns_unit_aware FAILED [ 96%]
tests/test_0850_units_closure_comprehensive.py::test_summary_closure_property PASSED [100%]

=================================== FAILURES ===================================
___________________ test_closure_variable_multiply_variable ____________________
tests/test_0850_units_closure_comprehensive.py:105: in test_closure_variable_multiply_variable
    assert hasattr(result, "units") or hasattr(result, "_units"), \
E   AssertionError: Variable * Variable should preserve unit-awareness
E   assert (False or False)
E    +  where False = hasattr(Matrix([[{ \hspace{ 0.0004pt } {T} }(N.x, N.y)*{ \hspace{ 0.0004pt } {V} }_{ 0 }(N.x, N.y)]]), 'units')
E    +  and   False = hasattr(Matrix([[{ \hspace{ 0.0004pt } {T} }(N.x, N.y)*{ \hspace{ 0.0004pt } {V} }_{ 0 }(N.x, N.y)]]), '_units')
---------------------------- Captured stdout setup -----------------------------
Structured box element resolution 4 4
______________________ test_closure_scalar_times_variable ______________________
tests/test_0850_units_closure_comprehensive.py:144: in test_closure_scalar_times_variable
    assert hasattr(result, "units") or hasattr(result, "_units"), \
E   AssertionError: Scalar * Variable should preserve unit-awareness
E   assert (False or False)
E    +  where False = hasattr(Matrix([[2*{ \hspace{ 0.0019pt } {T} }(N.x, N.y)]]), 'units')
E    +  and   False = hasattr(Matrix([[2*{ \hspace{ 0.0019pt } {T} }(N.x, N.y)]]), '_units')
---------------------------- Captured stdout setup -----------------------------
Structured box element resolution 4 4
________________________ test_closure_second_derivative ________________________
tests/test_0850_units_closure_comprehensive.py:203: in test_closure_second_derivative
    d2T_dx2 = dT_dx.diff(x)
              ^^^^^^^^^^^^^
../.pixi/envs/default/lib/python3.12/site-packages/sympy/matrices/matrixbase.py:3416: in diff
    deriv = ArrayDerivative(self, *args, evaluate=evaluate)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.pixi/envs/default/lib/python3.12/site-packages/sympy/tensor/array/array_derivatives.py:19: in __new__
    obj = super().__new__(cls, expr, *variables, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.pixi/envs/default/lib/python3.12/site-packages/sympy/core/function.py:1466: in __new__
    obj = cls._dispatch_eval_derivative_n_times(expr, v, count)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.pixi/envs/default/lib/python3.12/site-packages/sympy/tensor/array/array_derivatives.py:106: in _dispatch_eval_derivative_n_times
    result = cls._call_derive_matrix_by_scalar(expr, v)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.pixi/envs/default/lib/python3.12/site-packages/sympy/tensor/array/array_derivatives.py:64: in _call_derive_matrix_by_scalar
    return _matrix_derivative(expr, v)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.pixi/envs/default/lib/python3.12/site-packages/sympy/matrices/expressions/matexpr.py:538: in _matrix_derivative
    return _matrix_derivative_old_algorithm(expr, x)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.pixi/envs/default/lib/python3.12/site-packages/sympy/matrices/expressions/matexpr.py:552: in _matrix_derivative_old_algorithm
    lines = expr._eval_derivative_matrix_lines(x)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.pixi/envs/default/lib/python3.12/site-packages/sympy/core/expr.py:3986: in _eval_derivative_matrix_lines
    return [_LeftRightArgs([S.One, S.One], higher=self._eval_derivative(x))]
                                                  ^^^^^^^^^^^^^^^^^^^^^^^^
../.pixi/envs/default/lib/python3.12/site-packages/sympy/matrices/matrixbase.py:3423: in _eval_derivative
    return self.applyfunc(lambda x: x.diff(arg))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.pixi/envs/default/lib/python3.12/site-packages/sympy/matrices/matrixbase.py:2108: in applyfunc
    return self._eval_applyfunc(f)
           ^^^^^^^^^^^^^^^^^^^^^^^
../.pixi/envs/default/lib/python3.12/site-packages/sympy/matrices/matrixbase.py:2040: in _eval_applyfunc
    valmap = {v: f(v) for v in dok.values()}
                 ^^^^
../.pixi/envs/default/lib/python3.12/site-packages/sympy/matrices/matrixbase.py:3423: in <lambda>
    return self.applyfunc(lambda x: x.diff(arg))
                                    ^^^^^^^^^^^
../.pixi/envs/default/lib/python3.12/site-packages/sympy/core/expr.py:3606: in diff
    return _derivative_dispatch(self, *symbols, **assumptions)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.pixi/envs/default/lib/python3.12/site-packages/sympy/core/function.py:1938: in _derivative_dispatch
    return Derivative(expr, *variables, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.pixi/envs/default/lib/python3.12/site-packages/sympy/core/function.py:1466: in __new__
    obj = cls._dispatch_eval_derivative_n_times(expr, v, count)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.pixi/envs/default/lib/python3.12/site-packages/sympy/core/function.py:1927: in _dispatch_eval_derivative_n_times
    return expr._eval_derivative_n_times(v, count)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.pixi/envs/default/lib/python3.12/site-packages/sympy/core/basic.py:1975: in _eval_derivative_n_times
    obj = obj._eval_derivative(s)
          ^^^^^^^^^^^^^^^^^^^^^^^
../.pixi/envs/default/lib/python3.12/site-packages/sympy/core/function.py:610: in _eval_derivative
    df = self.fdiff(i)
         ^^^^^^^^^^^^^
src/underworld3/function/_function.pyx:91: in underworld3.function._function.UnderworldAppliedFunctionDeriv.fdiff
    raise RuntimeError("Second derivatives of Underworld functions are not supported at this time.")
E   RuntimeError: Second derivatives of Underworld functions are not supported at this time.
---------------------------- Captured stdout setup -----------------------------
Structured box element resolution 4 4
_________________ test_units_addition_incompatible_units_fails _________________
tests/test_0850_units_closure_comprehensive.py:337: in test_units_addition_incompatible_units_fails
    result = temperature_with_units.sym + velocity_with_units.sym[0]
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   TypeError: unsupported operand type(s) for +: 'MutableDenseMatrix' and '{ \hspace{ 0.0084pt } {V} }_{ 0 }'

During handling of the above exception, another exception occurred:
tests/test_0850_units_closure_comprehensive.py:344: in test_units_addition_incompatible_units_fails
    assert "units" in str(e).lower() or "dimension" in str(e).lower(), \
E   AssertionError: Error should mention units/dimensions: unsupported operand type(s) for +: 'MutableDenseMatrix' and '{ \hspace{ 0.0084pt } {V} }_{ 0 }'
E   assert ('units' in "unsupported operand type(s) for +: 'mutabledensematrix' and '{ \\hspace{ 0.0084pt } {v} }_{ 0 }'" or 'dimension' in "unsupported operand type(s) for +: 'mutabledensematrix' and '{ \\hspace{ 0.0084pt } {v} }_{ 0 }'")
E    +  where "unsupported operand type(s) for +: 'mutabledensematrix' and '{ \\hspace{ 0.0084pt } {v} }_{ 0 }'" = <built-in method lower of str object at 0x32c5cedc0>()
E    +    where <built-in method lower of str object at 0x32c5cedc0> = "unsupported operand type(s) for +: 'MutableDenseMatrix' and '{ \\hspace{ 0.0084pt } {V} }_{ 0 }'".lower
E    +      where "unsupported operand type(s) for +: 'MutableDenseMatrix' and '{ \\hspace{ 0.0084pt } {V} }_{ 0 }'" = str(TypeError("unsupported operand type(s) for +: 'MutableDenseMatrix' and '{ \\hspace{ 0.0084pt } {V} }_{ 0 }'"))
E    +  and   "unsupported operand type(s) for +: 'mutabledensematrix' and '{ \\hspace{ 0.0084pt } {v} }_{ 0 }'" = <built-in method lower of str object at 0x32c5cedc0>()
E    +    where <built-in method lower of str object at 0x32c5cedc0> = "unsupported operand type(s) for +: 'MutableDenseMatrix' and '{ \\hspace{ 0.0084pt } {V} }_{ 0 }'".lower
E    +      where "unsupported operand type(s) for +: 'MutableDenseMatrix' and '{ \\hspace{ 0.0084pt } {V} }_{ 0 }'" = str(TypeError("unsupported operand type(s) for +: 'MutableDenseMatrix' and '{ \\hspace{ 0.0084pt } {V} }_{ 0 }'"))
---------------------------- Captured stdout setup -----------------------------
Structured box element resolution 4 4
___________________ test_closure_evaluate_returns_unit_aware ___________________
../.pixi/envs/default/lib/python3.12/site-packages/underworld3/units.py:672: in dimensionalise
    scale = model.get_scale_for_dimensionality(dimensionality)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.pixi/envs/default/lib/python3.12/site-packages/underworld3/model.py:2154: in get_scale_for_dimensionality
    raise ValueError(
E   ValueError: Cannot find scale for dimension 'temperature'. Available fundamental scales: ['length', 'time', 'mass']. Provide more reference quantities to derive this scale.

During handling of the above exception, another exception occurred:
tests/test_0850_units_closure_comprehensive.py:487: in test_closure_evaluate_returns_unit_aware
    result = uw.function.evaluate(temperature_with_units.sym, pts)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.pixi/envs/default/lib/python3.12/site-packages/underworld3/function/functions_unit_system.py:191: in evaluate
    raw_result_dimensional = uw.dimensionalise(
../.pixi/envs/default/lib/python3.12/site-packages/underworld3/units.py:674: in dimensionalise
    raise ValueError(f"Cannot compute scale for dimensionality {dimensionality}: {e}")
E   ValueError: Cannot compute scale for dimensionality {'[temperature]': 1}: Cannot find scale for dimension 'temperature'. Available fundamental scales: ['length', 'time', 'mass']. Provide more reference quantities to derive this scale.
---------------------------- Captured stdout setup -----------------------------
Structured box element resolution 4 4
=============================== warnings summary ===============================
../.pixi/envs/default/lib/python3.12/site-packages/underworld3/utilities/__init__.py:32
  /Users/lmoresi/+Underworld/underworld-pixi-2/.pixi/envs/default/lib/python3.12/site-packages/underworld3/utilities/__init__.py:32: DeprecationWarning: The units_mixin module is deprecated and not used in production code. Use the hierarchical units system in enhanced_variables.py instead. This module is preserved only for historical reference.
    from .units_mixin import (

test_0850_units_closure_comprehensive.py::test_closure_evaluate_returns_unit_aware
  /Users/lmoresi/+Underworld/underworld-pixi-2/.pixi/envs/default/lib/python3.12/site-packages/underworld3/function/functions_unit_system.py:112: DeprecationWarning: unwrap() is deprecated and will be removed. Use expand() for user inspection or _unwrap_for_compilation() for solver code.
    expr_unwrapped = fn_unwrap(expr)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/test_0850_units_closure_comprehensive.py::test_closure_variable_multiply_variable
FAILED tests/test_0850_units_closure_comprehensive.py::test_closure_scalar_times_variable
FAILED tests/test_0850_units_closure_comprehensive.py::test_closure_second_derivative
FAILED tests/test_0850_units_closure_comprehensive.py::test_units_addition_incompatible_units_fails
FAILED tests/test_0850_units_closure_comprehensive.py::test_closure_evaluate_returns_unit_aware
================== 5 failed, 25 passed, 2 warnings in 11.81s ===================
Abort(868846735): Fatal error in internal_Finalize: Other MPI error, error stack:
internal_Finalize(50)............: MPI_Finalize failed
MPII_Finalize(441)...............: 
MPID_Finalize(804)...............: 
MPIDI_OFI_mpi_finalize_hook(1075): 
flush_send_queue(1034)...........: 
MPIDI_OFI_handle_cq_error(788)...: OFI poll failed (default nic=utun9: Input/output error)
